from selenium import webdriver
from selenium.webdriver.common.keys import Keys

from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

import time
import pandas as pd
from openpyxl import load_workbook

path = "C:/Program Files (x86)/chromedriver.exe"
driver = webdriver.Chrome(path)
driver.get("http://www.nexisuni.com/")

df = pd.read_excel("C:/Users/andre/OneDrive/Desktop/CVC_test.xlsx")

    
## INSERT CVC AND N INVESTMENTS ##
CVC = "Verizon"
num_inv = 2

## INSERT ROW -2 ILOC OF CVC ##
i = 2 -2
startups = [None]*num_inv
for i in range(len(startups)):
    startups[i] = df.iloc[i, 1]

## TARGET DATAFRAME INFO ##
alliances = pd.DataFrame(columns=['Startup', 'Header', 'Date'])


for startup in startups:
    
## SEARCH QUERY ##
    try:
        search = WebDriverWait(driver, 30).until(
            EC.presence_of_element_located((By.ID, "searchTerms"))
        )
        search.clear()
        search.send_keys("headline(" + CVC + ") and headline(" + startup + ") and headline(teams up) or headline(agreement)")
        search.send_keys(Keys.RETURN)
        
        # solo alleanze tech, aggiungere termini
    
## FIND ARTICLES' DATA ##
    finally:
        
        try:
            main = WebDriverWait(driver, 30).until(
                EC.presence_of_element_located((By.ID, "xzvnk"))
            )        
            
            articles = main.find_elements_by_xpath("//*[starts-with(@class,'row_sr')]")
            dates = main.find_elements_by_xpath("//dd[4]")
            headers = main.find_elements_by_xpath("//h2[@class='doc-title translate']")
            
            i = 0            
            for i in range(len(articles)):                
                alliances.loc[i, 'Startup'] = startup
            i = 0
            for header in headers: 
                alliances.loc[i, 'Header'] = header.text
                i += 1
            i = 0
            for date in dates:    
                alliances.loc[i, 'Date'] = date.text
                i += 1                                        
# discard close dates
    
        finally:
            time.sleep(1)   
            
print(alliances)
driver.quit()

## SAVE DATA ON EXCEL ##
excel_path = "C:/Users/andre/OneDrive/Desktop/CVC_alliances.xlsx"
writer = pd.ExcelWriter(excel_path, engine = 'openpyxl')
writer.book = load_workbook(excel_path)

alliances.to_excel(writer, sheet_name=CVC)
writer.save()
writer.close()
